# 你买我赠活动技术详细设计
本次活动的目的就是参与活动送赠品、如果赠品没有了预示着活动结束了。活动的状态要变更为结束状态。
需要有以下准备的条件分别为：

- 1. 活动主商品集合(有多少添加多少个主商品信息)
- 2. 活动赠品(关注赠品的库存)
- 3. 活动开始时间和结束时间(如果没有设置结束时间默认取其他条件确定活动的结束)
- 4. 活动的其他限制条件：区域条件
- 5. 活动够买次数、购买量等限制条件
- 6. 活动订单限制条件(下单限制规则中有约束、请参考 下单规则需求文档)
- 7. 在线支付成功送赠品方案设计
- 8. 开发周期

## 1. 活动主商品集合(有多少添加多少个主商品信息)
在运营后台需要提供一个地址提交活动说明、添加活动主商品信息

## 2. 活动赠品(关注赠品的库存)
需要发布赠品 作为买赠活动的赠品并设置合理的库存、保证赠品库存不能任意变更以保证活动有序进行。如果赠品购买完毕、活动暂停吗？
参考 2.1

### 2.1 赠品赠送完后活动结束
关于赠品赠送完毕后页面展示在步骤 5. 中 需要考虑

## 3. 活动开始时间和结束时间
注意活动的开始时间和结束时间(如果没有设置结束时间默认取其他条件确定活动的结束)、活动开始的条件是主商品有库存、赠品也有库存
。请保证一个调度任务去定时查询活动开始和活动暂停。调度任务参考 3.1 

### 3.1活动定时开始调度任务
该调度任务重点检查：参与活动的主商品是否有库存、参与活动的赠品是否有库存、确定到期时间关闭活动等任务。

## 4. 活动的其他限制条件：区域条件
如下解决方案：不参与活动的区域设置库存为 零 可以解决该限制条件。

## 5. 活动购买次数、购买量等限制条件
活动要求：每个会员限赠一个赠品。另外用户首单买了赠品的商品，第二单，还可以下单，只是不再赠送赠品 。因此要设计用户购买商品及松送赠品记录。
以下位置信息：
- 商品详情页显示(不显示赠品)
- 购物车页面显示(本次你买我赠 活动购物车不体现出来)
- 立即购买是否添加限制(也不用考虑)
- 订单结算页面显示(也不用考虑)
- 下单成功并符合在线支付及金额限制的条件(自动在订单中添加赠品商品)
关于赠品只能送一个或者享受一次优惠的详细设计可以参考: 单品促销设计。

## 6. 活动订单限制条件
下单限制规则中有约束、请参考 下单规则需求文档。下单规则需求已在紧张开发中。再次声明：选择配送区域为郑州市）金额不足500元，无法下单。（选择配送区域为河南省除郑州市其他地区）金额不足1000元，无法下单。这些属于  下单限制规则已经在开中了。不仅仅是为你买我增活动特有的订单限制金额条件，而是全华禽网商城的规则。

## 7.在线支付成功送赠品方案设计
需要对赠品活动表添加一个前台发赠品和后台系统自动发赠品的标识 具体解释参考 7.1 .付款之后到订单列表，显示赠品信息，即只有在线支付-付款成功后，才显示赠品信息，赠品生效。有两种方案可以做到、分别为：

 1. 使用消息中间件。在付款成功后调用消息中间加发送付款成功消息，需要一个业务逻辑方法(参考 7.2 )处理这个消息。
 2. 使用定时任务。每隔5~10秒扫描。扫描条件为：在线支付成功的订单。
 

### 7.1 赠品活动添加字段说明
赠品活动表添加一个Active_show_type字段类型：
 1. 前台页面显示赠品；只要满足赠品活动每次购买都赠送赠品赠送。
 2. 后台系统自动发送赠品；有诸多限制条件类似本次活动、业务逻辑前台不太容易处理放到后台把结果反馈给用户。


### 7.2 你买我赠赠品发送业务逻辑处理
需要一张存储”用户购买记录商品的记录表“可以参考--单品促销用户购买商品记录表。此表存储内容为：赠品、用户、订单号等重要信息。
然后进行如下逻辑判断：
 1. 查询赠品活动表、活动赠品信息及库存。有库存继续走下一步、无库存返回
 2. 查询订单支付 方式必须为在线支付；是走 下一步、否 直接返回
 3. 查询订单“用户购买记录商品的记录表” 查询是否有赠品记录在活动的开始时间。如果有记录直接返回、没有记录走下一步
 4. 查询订单金额是否满足送赠品的条件；满足走下一步 不满足直接 返回
 5. 保存”用户购买记录商品的记录表“ 、并添加一条赠品商品的记录在该订单的购买商品信息中。
 

## 8. 开发周期
供应商后台打印订单是否也要打印等问题(已经修改完毕可以满足本次活动)
